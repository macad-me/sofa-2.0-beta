name: ðŸ” Test CVE Pipeline

on:
  schedule:
    # Run at 6:00 AM and 6:00 PM UTC, Monday through Friday
    - cron: '0 6,18 * * 1-5'
  workflow_dispatch:
    inputs:
      use_api_key:
        description: 'Use API key for CVE enrichment'
        type: boolean
        default: true
      debug_mode:
        description: 'Enable verbose debugging'
        type: boolean
        default: false

env:
  PYTHON_VERSION: '3.13'

jobs:
  test-cve-pipeline:
    name: Test CVE Pipeline
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Set up UV
        uses: astral-sh/setup-uv@v3
        with:
          enable-cache: true
          cache-dependency-glob: "scripts/sofa_pipeline.py"
          
      - name: Download SOFA CLI binaries
        run: |
          echo "ðŸ“¥ Downloading SOFA CLI binaries..."
          mkdir -p bin
          
          DOWNLOAD_URL="https://github.com/headmin/sofa-core-cli/releases/download/v0.1.0-beta1"
          LINUX_ZIP="sofa-core-cli-x86_64-linux-binaries.zip"
          
          curl -L -f -o "$LINUX_ZIP" "$DOWNLOAD_URL/$LINUX_ZIP"
          unzip -o -j "$LINUX_ZIP" -d bin/
          chmod +x bin/*
          rm "$LINUX_ZIP"
          
          echo "Downloaded binaries:"
          ls -la bin/
          
      - name: Prepare test data
        run: |
          echo "ðŸ“‹ Preparing test data for CVE pipeline..."

          # Create necessary directories
          mkdir -p data/resources
          mkdir -p data/cache/html

          # We need Apple security releases data for CVE extraction
          # Run gather and fetch stages to get the required data
          export PATH="./bin:$PATH"

          echo "Running gather stage to get Apple security data..."
          if uv run --script scripts/sofa_pipeline.py run --stage gather; then
            echo "âœ… Gather completed"
          else
            echo "âŒ Gather failed - continuing anyway"
          fi

          echo "Running fetch stage to get Apple security releases..."
          if uv run --script scripts/sofa_pipeline.py run --stage fetch; then
            echo "âœ… Fetch completed - ready for CVE processing"
          else
            echo "âŒ Fetch failed - will try CVE pipeline anyway"
          fi
          
      - name: Test CVE pipeline (Direct Binary)
        env:
          VULNCHECK_API_KEY: ${{ secrets.VULNCHECK_API_KEY }}
        run: |
          echo "ðŸ” Testing CVE pipeline with direct binary calls..."

          export PATH="./bin:$PATH"

          # For scheduled runs, always use API key if available
          # For manual runs, respect the use_api_key input
          USE_API_KEY="true"
          if [ "${{ github.event_name }}" == "workflow_dispatch" ] && [ "${{ github.event.inputs.use_api_key }}" == "false" ]; then
            USE_API_KEY="false"
          fi

          if [ "$USE_API_KEY" == "true" ]; then
            if [ -z "$VULNCHECK_API_KEY" ]; then
              echo "âŒ VULNCHECK_API_KEY secret not set"
              echo "## âŒ CVE Pipeline Failed" >> $GITHUB_STEP_SUMMARY
              echo "VULNCHECK_API_KEY secret not configured" >> $GITHUB_STEP_SUMMARY
              exit 1
            fi
            echo "âœ… API key configured: ${VULNCHECK_API_KEY:0:8}..."
            echo "Running with API key enrichment"
          else
            echo "â„¹ï¸ Running without API key (extract and index only)"
          fi

          echo "Step 1: CVE extraction"
          if ./bin/sofa-cve extract; then
            echo "âœ… CVE extraction completed"
          else
            echo "âŒ CVE extraction failed"
            echo "## âŒ CVE Pipeline Failed" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

          if [ "$USE_API_KEY" == "true" ]; then
            echo "Step 2: CVE enrichment (with API key)"
            if ./bin/sofa-cve enrich; then
              echo "âœ… CVE enrichment completed"
            else
              echo "âŒ CVE enrichment failed"
              echo "## âŒ CVE Pipeline Failed" >> $GITHUB_STEP_SUMMARY
              exit 1
            fi
          else
            echo "Step 2: Skipping CVE enrichment (no API key)"
          fi

          echo "Step 3: CVE indexing"
          if ./bin/sofa-cve index; then
            echo "âœ… CVE indexing completed"
            if [ "$USE_API_KEY" == "true" ]; then
              echo "## âœ… CVE Pipeline Success (With Enrichment)" >> $GITHUB_STEP_SUMMARY
              echo "CVE pipeline completed successfully with API key enrichment" >> $GITHUB_STEP_SUMMARY
            else
              echo "## âœ… CVE Pipeline Success (Extract Only)" >> $GITHUB_STEP_SUMMARY
              echo "CVE pipeline completed successfully (extract and index only)" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "âŒ CVE indexing failed"
            echo "## âŒ CVE Pipeline Failed" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

      - name: Show CVE results
        if: always()
        run: |
          echo "ðŸ“Š CVE Pipeline Results..."
          echo ""

          echo "Generated CVE files:"
          find data/ -name "*cve*" -type f 2>/dev/null | head -10 || echo "No CVE files found"
          echo ""

          echo "Key output files:"
          if [ -f "data/resources/apple_cves_with_context.ndjson" ]; then
            echo "âœ… CVE extraction: $(wc -l < data/resources/apple_cves_with_context.ndjson) CVEs extracted"
          else
            echo "âŒ No CVE extraction file found"
          fi

          if [ -f "data/feeds/cve_enriched.ndjson" ]; then
            echo "âœ… CVE enrichment: $(wc -l < data/feeds/cve_enriched.ndjson) CVEs enriched ($(stat -c%s data/feeds/cve_enriched.ndjson 2>/dev/null || stat -f%z data/feeds/cve_enriched.ndjson 2>/dev/null) bytes)"
          else
            echo "â„¹ï¸ No CVE enrichment file (expected when API key not used)"
          fi

          echo ""
          echo "Sample CVE data:"
          if [ -f "data/resources/apple_cves_with_context.ndjson" ]; then
            head -1 data/resources/apple_cves_with_context.ndjson | jq -r '.cve_id // .id // "No CVE ID"' 2>/dev/null || echo "Could not parse CVE data"
          fi
          
      - name: Test direct CVE command
        if: github.event.inputs.debug_mode == true
        run: |
          echo "ðŸ§ª Testing sofa-cve binary directly..."
          
          export PATH="./bin:$PATH"
          
          echo "sofa-cve help:"
          ./bin/sofa-cve --help || echo "Help command failed"
          echo ""
          
          echo "sofa-cve version:"
          ./bin/sofa-cve --version || echo "Version command failed"
          echo ""
          
          if [ -f "data/resources/apple_security_releases.json" ]; then
            echo "Testing direct CVE extract:"
            ./bin/sofa-cve extract || echo "Direct extract failed"
          else
            echo "No Apple security releases data found for direct test"
          fi
