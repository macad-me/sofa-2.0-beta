# GitHub Actions workflow for PUBLIC repository

name: Fetch SOFA Metrics from Private Repo

on:
  schedule:
    - cron: '45 */6 * * *'   # 45 minutes after private repo collection
  workflow_dispatch:
    inputs:
      force_update:
        description: "Force update even if no changes detected"
        required: false
        default: "false"
        type: boolean
      output_path:
        description: "Path where metrics should be saved (e.g., data/resources/metrics.json)"
        required: false
        default: "data/resources/metrics.json"

permissions:
  contents: write

concurrency:
  group: fetch-sofa-metrics-${{ github.ref }}
  cancel-in-progress: false

jobs:
  fetch-metrics:
    runs-on: ubuntu-latest
    
    env:
      PRIVATE_REPO_TOKEN: ${{ secrets.PRIVATE_REPO_TOKEN }}
      OUTPUT_PATH: ${{ inputs.output_path || vars.METRICS_OUTPUT_PATH || 'data/resources/metrics.json' }}
    
    steps:
      - name: Checkout public repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Fetch metrics from private repo
        run: |
          echo "üîÑ Fetching metrics from macad-me/sofa-metrics-collector..."
          
          # Fetch file content via GitHub API
          curl -H "Authorization: Bearer $PRIVATE_REPO_TOKEN" \
               -H "Accept: application/vnd.github.v3+json" \
               -H "User-Agent: SOFA-Metrics-Fetcher/1.0" \
               -s \
               https://api.github.com/repos/macad-me/sofa-metrics-collector/contents/data/metrics/latest.json > api_response.json
          
          # Check if request was successful
          if [ $(jq -r '.message // "success"' api_response.json) != "success" ]; then
            echo "‚ùå API Error: $(jq -r '.message' api_response.json)"
            exit 1
          fi
          
          # Decode base64 content and save to output path
          mkdir -p "$(dirname "$OUTPUT_PATH")"
          jq -r '.content' api_response.json | base64 -d > temp_metrics.json
          
          # Transform for public (remove internal fields, add source)
          jq '. + {"source": "sofa-metrics-collector"} | del(.notes?)' temp_metrics.json > "$OUTPUT_PATH"
          
          # Display summary
          echo "‚úÖ Successfully fetched and saved metrics to: $OUTPUT_PATH"
          echo "üìä Metrics Summary:"
          echo "   Total Requests: $(jq -r '.metrics.totalRequests.formatted' "$OUTPUT_PATH")"
          echo "   Page Views: $(jq -r '.metrics.pageViews.formatted' "$OUTPUT_PATH")"  
          echo "   Bandwidth: $(jq -r '.metrics.bandwidth.formatted' "$OUTPUT_PATH")"
          echo "   Cache Ratio: $(jq -r '.metrics.cacheRatio.formatted' "$OUTPUT_PATH")"
          
          # Cleanup temp files
          rm -f api_response.json temp_metrics.json

      - name: Check for changes
        id: changes
        run: |
          # Check if metrics file has changed
          if git diff --quiet "$OUTPUT_PATH" 2>/dev/null; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "üìä No changes detected in metrics"
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "üìä Changes detected in metrics"
          fi

      - name: Setup git
        if: steps.changes.outputs.has_changes == 'true' || inputs.force_update == 'true'
        run: |
          git config user.name "SOFA Metrics Bot"
          git config user.email "metrics-bot@macadmin.me"

      - name: Commit updated metrics
        if: steps.changes.outputs.has_changes == 'true' || inputs.force_update == 'true'
        run: |
          # Extract key metrics for commit message
          TIMESTAMP=$(jq -r '.timestamp' "$OUTPUT_PATH")
          REQUESTS=$(jq -r '.metrics.totalRequests.formatted' "$OUTPUT_PATH")
          PAGEVIEWS=$(jq -r '.metrics.pageViews.formatted' "$OUTPUT_PATH") 
          BANDWIDTH=$(jq -r '.metrics.bandwidth.formatted' "$OUTPUT_PATH")
          CACHE_RATIO=$(jq -r '.metrics.cacheRatio.formatted' "$OUTPUT_PATH")
          
          git add "$OUTPUT_PATH"
          git commit -m "üìä Update SOFA metrics ($(date -d "$TIMESTAMP" '+%Y-%m-%d %H:%M' 2>/dev/null || date -j -f "%Y-%m-%dT%H:%M:%S.%fZ" "$TIMESTAMP" '+%Y-%m-%d %H:%M' 2>/dev/null || echo "$TIMESTAMP"))

          - Requests: $REQUESTS
          - Page Views: $PAGEVIEWS
          - Bandwidth: $BANDWIDTH  
          - Cache Ratio: $CACHE_RATIO
          
          Auto-updated from sofa-metrics-collector"

      - name: Push changes
        if: steps.changes.outputs.has_changes == 'true' || inputs.force_update == 'true'
        run: |
          git push

      - name: Upload metrics artifact
        uses: actions/upload-artifact@v4
        with:
          name: sofa-metrics-${{ github.run_id }}
          path: ${{ env.OUTPUT_PATH }}
          retention-days: 30

  verify-metrics:
    runs-on: ubuntu-latest
    needs: fetch-metrics
    if: always()
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Verify metrics file
        env:
          OUTPUT_PATH: ${{ inputs.output_path || vars.METRICS_OUTPUT_PATH || 'data/resources/metrics.json' }}
        run: |
          if [ -f "$OUTPUT_PATH" ]; then
            echo "‚úÖ Metrics file exists at: $OUTPUT_PATH"
            echo "üìä File size: $(wc -c < "$OUTPUT_PATH") bytes"
            echo "üïí Timestamp: $(jq -r '.timestamp' "$OUTPUT_PATH" 2>/dev/null || echo 'Invalid JSON')"
            
            # Validate JSON structure
            if jq empty "$OUTPUT_PATH" 2>/dev/null; then
              echo "‚úÖ Valid JSON format"
            else
              echo "‚ùå Invalid JSON format"
            fi
          else
            echo "‚ùå Metrics file not found at: $OUTPUT_PATH"
          fi